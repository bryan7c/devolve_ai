import { useState, useEffect } from "react";
import Head from "next/head";
import { InternalLayout } from "@/src/layout/internalLayout";
import { Button, Chip, Dialog, DialogActions, DialogContent, DialogContentText, DialogTitle, Divider, Grid, IconButton, InputBase, MenuItem, Paper } from "@mui/material";
import { deleteReturnedItem, getReturnedItems } from "@/src/services/ReturnedService";
import CardReturnedItem from "@/src/components/CardReturnedItem/CardReturnedItem";
import ActionMenu from "@/src/components/ActionMenu/ActionMenu";
import { Search } from "@mui/icons-material";
import { DatePicker, LocalizationProvider } from '@mui/x-date-pickers';
import { AdapterDayjs } from '@mui/x-date-pickers/AdapterDayjs';

function ReturnedPage() {
  const [returnedList, setReturnedList] = useState([]);
  const [open, setOpen] = useState(false);
  const [selectedReturnedItemId, setSelectedReturnedItemId] = useState(null);

  const [searchValue, setSearchValue] = useState("");

  const handleSearchChange = (event) => {
    setSearchValue(event.target.value);
  };

  const handleSearchSubmit = () => {
    setReturnedList(
      returnedList.filter((returnedItem) =>
        returnedItem.localDevolucao.toLowerCase().includes(searchValue.toLowerCase())
      )
    )
  };

  const handleDeleteConfirmation = (returnedItemId) => {
    setSelectedReturnedItemId(returnedItemId);
    setOpen(true);
  };

  const handleClose = () => {
    setSelectedReturnedItemId(null);
    setOpen(false);
  };

  useEffect(() => {
    async function fetchReturned() {
      getReturnedItems().then((data) => {
        setReturnedList(data);
      });
    }

    fetchReturned();
  }, []);

  const handleEdit = (returnedItemId) => {
    alert(`Editando devolução ${returnedItemId}`);
  };

  const handleDelete = () => {
    deleteReturnedItem(selectedReturnedItemId).then(() => {
      setReturnedList(
        returnedList.filter(
          (returnedItem) => returnedItem._id !== selectedReturnedItemId
        )
      );
      handleClose();
    });
  };

  return (
    <>
      <Head>
        <title>Devolução</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <Paper
        component="form"
        sx={{
          p: "2px 4px",
          display: "flex",
          alignItems: "center",
          marginBottom: 2,
        }}
      >
        <IconButton type="button" sx={{ p: "10px" }} aria-label="search">
          <Search />
        </IconButton>
        <InputBase
          sx={{ ml: 1, flex: 1 }}
          placeholder="Pesquisar devolução"
          value={searchValue}
          onChange={handleSearchChange}
          onKeyDown={(event) => {
            if (event.key === 'Enter') {
              handleSearchSubmit();
            }
          }}
        />
        <Divider sx={{ height: 28, m: 0.5 }} orientation="vertical" />
        <LocalizationProvider dateAdapter={AdapterDayjs}>
          <DatePicker label="Basic date picker" />
        </LocalizationProvider>
        <Chip
          color="info"
          onClick={function () {}}
          size="small"
          sx={{ height: 20, width: 40, margin: '0 .3em' }}
          variant="solid"
        />
        <Chip
          color="secondary"
          onClick={function () {}}
          size="small"
          sx={{ height: 20, width: 40, margin: '0 .3em' }}
          variant="solid"
        />
        <Chip
          color="success"
          onClick={function () {}}
          size="small"
          sx={{ height: 20, width: 40, margin: '0 .3em' }}
          variant="solid"
        />
      </Paper>
      <Grid container spacing={2}>
        {returnedList.map((returnedItem) => (
          <CardReturnedItem
            key={returnedItem._id}
            returnedItem={returnedItem}
            action={
              <ActionMenu>
                <MenuItem onClick={() => handleEdit(returnedItem._id)}>
                  Editar
                </MenuItem>
                <MenuItem
                  onClick={() => handleDeleteConfirmation(returnedItem._id)}
                >
                  Excluir
                </MenuItem>
              </ActionMenu>
            }
          />
        ))}
      </Grid>
      <Dialog
        open={open}
        onClose={handleClose}
        aria-labelledby="responsive-dialog-title"
      >
        <DialogTitle id="responsive-dialog-title">
          {"Deletar devolução?"}
        </DialogTitle>
        <DialogContent>
          <DialogContentText>
            Tem certeza que deseja excluir este item?
          </DialogContentText>
        </DialogContent>
        <DialogActions>
          <Button autoFocus onClick={handleClose}>
            Cancelar
          </Button>
          <Button onClick={handleDelete} autoFocus>
            Deletar
          </Button>
        </DialogActions>
      </Dialog>
    </>
  );
}
ReturnedPage.PageLayout = InternalLayout;

export default ReturnedPage;
