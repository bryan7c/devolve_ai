import { useState } from "react";
import Head from "next/head";
import { InternalLayout } from "@/src/layout/internalLayout";
import { useRouter } from "next/router";
import { updateReturnedItem } from "@/src/services/ReturnedService";
import { Button, Grid, IconButton, Paper } from "@mui/material";
import { Search } from "@mui/icons-material";
import { DatePicker, LocalizationProvider } from "@mui/x-date-pickers";
import { AdapterDayjs } from "@mui/x-date-pickers/AdapterDayjs";
import dayjs from "dayjs";
import "dayjs/locale/pt-br";
import dynamic from "next/dynamic";
import {
  MapResultContainer,
  MapResultItem,
} from "@/src/components/map/locationResultItem";
import { useLoadScript } from "@react-google-maps/api";
const Map = dynamic(() => import("@/src/components/map/index"), { ssr: false });
const AutoCompleteLocation = dynamic(
  () => import("@/src/components/map/AutoCompleteLocation"),
  { ssr: false }
);

export async function getServerSideProps({ query }) {
  const id = query.id.toString();
  const baseUrl = process.env.API_URL;
  const url = `${baseUrl}/returned?id=${id}`;
  const returnedItem = await fetch(url).then((response) => response.json());

  return {
    props: {
      returnedItem: returnedItem[0],
    },
  };
}

const libraries = ["places"];
function ReturnedPage({ returnedItem }) {
  const [returnedItemDate, setReturnedItemDate] = useState(
    dayjs(returnedItem.dataLimite)
  );
  const [results, setResults] = useState([]);
  const [locations, setLocations] = useState([]);
  const [destination, setDestination] = useState(returnedItem.coordenadas);
  const router = useRouter();

  const handleSave = async () => {
    returnedItem.coordenadas = destination;

    updateReturnedItem(returnedItem).then(() => {
      router.push("/");
    });
  };

  function onPlaceChanged(place) {
    setDestination(place);
  }

  function onResult(locationList) {
    setLocations(locationList);
    setResults(locationList);
  }

  function handleReturnedDate(newDate) {
    setReturnedItemDate(newDate);
    returnedItem.dataLimite = newDate.$d;
  }

  const { isLoaded } = useLoadScript({
    googleMapsApiKey: "AIzaSyDEI0-FS-iJl25mu23dSfFLzodOZZ4Vr3k",
    libraries: libraries,
    id: "google-map-script",
  });

  return (
    <>
      <Head>
        <title>Editando a devolução {returnedItem.titulo}</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <Paper
        elevation={3}
        sx={{
          p: "1em",
          height: "100%",
        }}
      >
        <Grid container spacing={2} sx={{ height: "100%" }} flexDirection={"column"}>
          <Grid container item xs={"auto"}>
            <Grid item xs={"auto"}>
              <IconButton type="button" sx={{ p: "10px" }} aria-label="search">
                <Search />
              </IconButton>
            </Grid>
            <Grid item xs sx={{ p: "10px" }}>
              <AutoCompleteLocation
                placeholder="Pesquisar devolução"
                onPlaceChanged={onPlaceChanged}
                isLoaded={isLoaded}
                onResult={onResult}
              />
            </Grid>
          </Grid>
          <Grid container item xs>
            <Grid container item xs={2} spacing={2} flexDirection={"column"}>
              <Grid item xs>
                <MapResultContainer id="map">
                  {results.map((result) => (
                    <MapResultItem
                      key={result.place_id}
                      onClick={() => setDestination(result)}
                      groupName={"returnedLoc"}
                      title={result.name}
                      subtitle="R$14,20"
                    />
                  ))}
                </MapResultContainer>
              </Grid>
              {/* {JSON.stringify(returnedItem)} */}
              <Grid item xs={"auto"}>
                <LocalizationProvider
                  dateAdapter={AdapterDayjs}
                  adapterLocale="pt-br"
                >
                  <DatePicker
                    label="Data limite"
                    onChange={(newDate) => handleReturnedDate(newDate)}
                    value={returnedItemDate}
                  />
                </LocalizationProvider>
              </Grid>
              <Grid
                item
                container
                xs={"auto"}
                justifyContent={"end"}
                flexDirection={"column"}
              >
                <Button
                  xs={12}
                  variant="contained"
                  size="large"
                  color="info"
                  onClick={handleSave}
                >
                  SALVAR
                </Button>
              </Grid>
            </Grid>
            <Grid item xs pl={2}>
              <Map
                locations={locations}
                destination={destination}
                isLoaded={isLoaded}
              />
            </Grid>
          </Grid>
        </Grid>
      </Paper>
    </>
  );
}
ReturnedPage.PageLayout = InternalLayout;

export default ReturnedPage;
